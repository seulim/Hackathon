@{
	Layout = "~/Views/Shared/_Layout_320.cshtml";
}
@using GMKT.GMobile.Data;
@using GMKT.GMobile.Web.Models;
@model ECouponHomeModel
@section Css {
	<link rel="stylesheet" type="text/css" href="@Urls.StyleUrl/320/etc_2013.css" />
}
	<!-- CONTENT -->
	<div id="content" class="ctns">
		<div class="ecpn_tit">
			<h3>e쿠폰</h3>
			<div class="func">
				<a href="#" class="sns" onclick="popBlockUI('layer_sns');return false;">공유하기</a>
		@if (!PageAttr.IsIphone && !PageAttr.IsIpad && !PageAttr.IsIpod)
        {
			if (PageAttr.IsAndroidApp) 
			{
				<a onclick="sendScheme()" class="down">페이지 다운로드</a>
			}
			else
			{			    
				<a onclick="checkApplicationInstall()" class="down">페이지 다운로드</a>
			}
		}
			</div>
		</div>
		<!-- BANNER -->	
		<div class="ban_wrap ecoupon">
			<div class="bn_grp ban" id="bnGrp">
				<ul>
				@foreach(ECouponEvent banner in Model.bannerlist) {
					<li><a href="@banner.LinkUrl"><img src="@banner.BannerImageUrl" alt="@banner.EventName" /></a></li>
				}
				</ul>
			</div>
			<div id="bnTurn" class="bn_eturn" style="display:none;">
				<button type="button" id="prev" class="prev" onclick="gallery1.prev();return false;"><span></span></button>
				<button type="button" id="next" class="next" onclick="gallery1.next();return false;"><span></span></button>
			</div>
			<div id="bnIndex12" class="bn_eindex">
			@for(var i=0; i < Model.bannerlist.Count; i++) {
				if (i==0) {
					<p class="selected"></p>
				} else {
					<p></p>
				}
					
			}
			</div>
		</div>
		<!-- //BANNER -->
		
		<div class="brand_list">
		@foreach(ECouponCategoryModel category in Model.categorylist) {
			<h4 class="tit"><strong>@category.CategoryName</strong>(@category.BrandCount)</h4>
			<ul class="lst">
			@foreach(ECouponBrand brand in category.brandlist) {
				<li><a href="/ecoupon/brand?brandcode=@brand.BrandCode"><img src="@brand.LogoImageUrl" alt="@brand.BrandName" /><span class="name">@brand.BrandName</span></a></li>
			}
			</ul>
		}
		</div>
		
@if (!PageAttr.IsIphone && !PageAttr.IsIpad && !PageAttr.IsIpod)
{
		if (PageAttr.IsAndroidApp)
		{
		<div class="ecpn_home"><a onclick="sendScheme()"><em>e쿠폰</em> 홈화면 바로가기 추가</a></div>   
		}
		else
		{			    
		<div class="ecpn_home"><a onclick="checkApplicationInstall()"><em>e쿠폰</em> 홈화면 바로가기 추가</a></div>
		}
} 
		
		<div class="share_sns" id="layer_sns">
			<h4 class="tit">공유하기</h4>
			<div class="sns">
				<a href="javascript:CheckPc(MobileSnsUtil.snsType().KAKAOTALK);" class="cco" id="SnsKakaoTalk">카카오톡</a>
				<a href="javascript:ShareTo(MobileSnsUtil.snsType().FACEBOOK);" class="face">페이스북</a>
				<a href="javascript:ShareTo(MobileSnsUtil.snsType().TWITTER);" class="twt">트위터</a>
				<a href="javascript:ShareTo(MobileSnsUtil.snsType().KAKAOSTORY);" class="ccos">카카오스토리</a>
			</div>
			<a href="#" class="close_sns" onclick="popBlockUI('layer_sns');return false;">닫기</a>
		</div>
	</div>
	<!-- //CONTENT -->

<script type="text/javascript">
	/* 이미지 높이값 고정 */
	$(window).on("resize", function(){
		setImgHeight();
	});
	function setImgHeight(){
		var $bnr_img = $('#bnGrp a img');
		$bnr_img.height($bnr_img.width() * 0.422);//0.422 : 배너 가로세로 비율
	}
	setImgHeight();
	/* //이미지 높이값 고정 */

	var	gallery1,
		el,
		i,
		page,
		dots1 = document.querySelectorAll('#bnTurn button'),
		dots12 = document.querySelectorAll('#bnIndex12 p');
	/* HTML 파싱 */
	var bnGrpList1 = $("#bnGrp li");

	if(1 < bnGrpList1.length){
				
		var bnGrpListAtag1 = [];

		// 시작포인트 랜덤 -> 우선순위순으로
		var index1 = 0;
//		var randomPage1 = Math.floor(Math.random() * (bnGrpList1.length));
//		for (var j = randomPage1; j < bnGrpList1.length; j++, index1++) {
//			bnGrpListAtag1[index1] = bnGrpList1[j].innerHTML;
//		}
//		if (randomPage1 > 0) {
//			for (var j = 0; j < randomPage1; j++, index1++) {
//				bnGrpListAtag1[index1] = bnGrpList1[j].innerHTML;
//			}
//		}
		for (var j = 0; j < bnGrpList1.length; j++, index1++) {
			bnGrpListAtag1[index1] = bnGrpList1[j].innerHTML;
		}

		var globalBnGrpListAtag1 = bnGrpListAtag1.join(",");
		/* //HTML 파싱 */

		gallery1 = new SwipeView('#bnGrp', { 
			numberOfPages: bnGrpListAtag1.length, 
			hastyPageFlip: true,
			flickTime: 1000 
		});

		// Load initial data
		for (i=0; i<3; i++) {

			if(1 == bnGrpListAtag1.length){
				page = i == 0 || 2 ? bnGrpListAtag1.length - 1 : i - 1;	
			}
			else{
				page = i == 0 ? bnGrpListAtag1.length - 1 : i - 1;
			}
			el = document.createElement('span');
			el.innerHTML = bnGrpListAtag1[page];
			gallery1.masterPages[i].appendChild(el)

			el.width = bnGrpListAtag1[page].width;
			el.height = bnGrpListAtag1[page].height;
			el.onload = function () { this.className = ''; }
		}

		gallery1.onFlip(function () {
			var el,
				upcoming,
				i;

			for (i=0; i<3; i++) {
				upcoming = gallery1.masterPages[i].dataset.upcomingPageIndex;

				if (upcoming != gallery1.masterPages[i].dataset.pageIndex) {
					el = gallery1.masterPages[i].querySelector('span');
					el.innerHTML = bnGrpListAtag1[upcoming];
				}
			}
			document.querySelector('#bnIndex12 .selected').className = '';
			dots12[gallery1.pageIndex].className = 'selected';
		});

		flicking("bnGrp", "prev", "next");
		$('#bnTurn').show();

	}else if(1 == bnGrpList1.length){ 

		var bnGrpListAtag1 = [];
				
		for(var j=0;j<bnGrpList1.length;j++){
			bnGrpListAtag1[j] = bnGrpList1[j].innerHTML;
		}
		var globalBnGrpListAtag1 = bnGrpListAtag1.join(",");
		/*140128*/
		var elSpan = document.createElement('span');
		elSpan.innerHTML = globalBnGrpListAtag1;
		document.querySelector('#bnGrp').appendChild(elSpan);
		//$("#bnGrp").append(globalBnGrpListAtag1);
		/* //140128*/

		flicking("bnGrp", "prev", "next");
		$('#bnTurn').show();
	} 
</script>
<script type="text/javascript" src="@(Urls.ScriptUrl)/js/mobile/main/common/MobileSnsUtil.js?v=1"></script>
<script type="text/javascript" src="@Urls.ScriptUrl/js/mobile/main/common/kakao.js?v=1"></script>
<script type="text/javascript">
	$(document).ready(function () {
		displayLayer("progress_icon", "none");
		KakaoInit();
		ShareTo("kakaotalk");
	});

	var ShareTo = function (type) {

		var data = {
			"name": "[G마켓]e쿠폰",
			"url": "@Urls.MobileWebUrl" + "/ecoupon",
			"title": ""
		};
		if (type == "kakaotalk") {
			KakaoController('#SnsKakaoTalk', new SnsParam(type, data), 'home');
		}
		else {
			var sender = MobileSnsUtil.sns(type).sender;
			sender.send(type, new SnsParam(type, data))
		}
	}

	var url = "Intent://CreateGService_Shortcut?page=ecoupon#Intent;action=android.intent.action.VIEW;category=android.intent.category.BROWSABLE;scheme=gmarket;package=com.ebay.kr.gmarket;end";
	function getAndroidVersion() {
		var androidVersion = -1; // def value, for non-Android devices
		var ua = navigator.userAgent.toLowerCase();
		var androidIndex = ua.indexOf('android');

		if (androidIndex != -1) {
			var versionStartIndex = androidIndex + 8;
			var versionEndIndex = ua.indexOf(';', versionStartIndex);

			androidVersion = parseFloat(ua.slice(versionStartIndex, versionEndIndex));
		}

		return androidVersion;
	}

	function checkApplicationInstall() {
		if (getAndroidVersion() >= 4.3) window.location.href = url;
		else {
			var iframe = document.createElement("iframe");
			iframe.id = "checkframe";
			iframe.name = "checkframe";
			iframe.style.width = "0px";
			iframe.style.height = "0px";
			iframe.style.display = "none";
			document.body.appendChild(iframe);

			document.checkframe.location = "gmarket://CreateGService_Shortcut?page=ecoupon";
			setTimeout("checkApplicationInstall_callback()", 500);
		}
	}

	function checkApplicationInstall_callback() {
		try {

			var s = document.checkframe.document.body.innerHTML;
			$("#checkframe").remove();
		} catch (e) {
			document.location = "market://details?id=com.ebay.kr.gmarket";
		}
	}

	function sendScheme() {

		var appVersion = checkAppVersion();

		if (appVersion != '' && parseInt(appVersion) < 340) {
			if (confirm("고객님 G마켓 앱의 업데이트가 필요합니다.") == false) {
				return;
			} else {
				document.location = "market://details?id=com.ebay.kr.gmarket";
			}
		}
		else {
			var iframe = document.createElement("iframe");
			iframe.id = "checkframe";
			iframe.name = "checkframe";
			iframe.style.width = "0px";
			iframe.style.height = "0px";
			iframe.style.display = "none";
			document.body.appendChild(iframe);

			document.checkframe.location = "gmarket://CreateGService_Shortcut?page=ecoupon";
			setTimeout("checkApplicationInstall_callback2()", 500);
		}
	}

	function checkApplicationInstall_callback2() {
		try {

			var s = document.checkframe.document.body.innerHTML;
			$("#checkframe").remove();
		} catch (e) {

		}
	}

	function checkAppVersion() {
		var sName = "appversion";
		var aCookie = document.cookie.split("; ");

		for (var i = 0; i < aCookie.length; i++) {
			var aCrumb = aCookie[i].split("=");
			if (sName == aCrumb[0])
				return unescape(aCrumb[1]);
		}
		return null;
	}
</script>
